@model List<PostexS.Models.Domain.Order>
@{
    ViewBag.Title = "طباعه الطلبات";
    var Ids = Model.Select(x => x.Id);
    var orderIds = Model.Select(o => o.Id).ToList();  // لاستخدامها في JS
}
<link href="~/css/printsite.css" rel="stylesheet" />
<div class="row">
    <div class="box-header with-border no-print">
        <h3 class="box-title no-print">@ViewBag.Title</h3>
        <div class="box-tools pull-right no-print">
            <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
        </div>
        <h4 style="margin: 10px; text-align: center;" class="no-print">
            <br />
            <a href="/Orders/Index" class="btn btn-default no-print">العودة</a>
            <button type="button" onclick="markAndPrint('normal');" class="btn btn-default"><i class="fa fa-print"></i> طباعة عادية</button>
            <div class="btn-group no-print" style="display:inline-block;">
                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-print"></i> طباعة حرارية <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a href="#" onclick="markAndPrint('thermal', '7.5x13'); return false;">7.5 × 13 سم</a></li>
                    <li><a href="#" onclick="markAndPrint('thermal', '10x10'); return false;">10 × 10 سم</a></li>
                    <li><a href="#" onclick="markAndPrint('thermal', '10x15'); return false;">10 × 15 سم</a></li>
                </ul>
            </div>
        </h4>
    </div><!-- /.box-header -->
    <form asp-action="PrintAllNew" asp-controller="Orders" method="get">
        <button class="btn btn-success form-control no-print" type="submit">تطبيق التحديد</button>
        @for (var i = 0; i < Model.Count; i++)
        {
            var order = Model[i];
            var CreatedOn = TimeZoneInfo.ConvertTimeFromUtc(order.CreateOn, TimeZoneInfo.FindSystemTimeZoneById("Egypt Standard Time"));

            <div class="box-body row" style="height: auto;margin:auto">
                <!-- المحتوى الأصلي -->
                <div class="text-center" style="margin-bottom:4px;">
                    @if (order.BarcodeImage != null)
                    {
                        <img src="data:image/png;base64,@Convert.ToBase64String(order.BarcodeImage)" alt="Barcode" style="position: absolute;right: 20px; margin-top:0px;">
                    }
                    <h4 style="margin-bottom:8px;">الطلب رقم @(order.Code)</h4>
                    <div>
                        <h4 style="margin:4px">
                            @if (order.IsDeleted == true)
                            {
                                <span class="badge bg-red">محذوف</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Placed)
                            {
                                <span class="badge bg-gray">جديد</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.PartialReturned)
                            {
                                <span class="badge bg-yellow-active">مرتجع جزئي</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Returned)
                            {
                                <span class="badge bg-yellow">مرتجع كامل</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Returned_And_DeliveryCost_On_Sender)
                            {
                                <span class="badge bg-yellow">مرتجع وشحن على الراسل</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Returned_And_Paid_DeliveryCost)
                            {
                                <span class="badge bg-yellow">مرتجع ودفع شحن </span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Delivered_With_Edit_Price)
                            {
                                <span class="badge bg-blue-active">تم التوصيل مع تعديل السعر</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.PartialDelivered)
                            {
                                <span class="badge bg-blue-active">تم التوصيل جزئي</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Assigned)
                            {
                                <span class="badge bg-green">جارى التوصيل</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Delivered)
                            {
                                <span class="badge bg-blue-active">تم التوصيل</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Rejected)
                            {
                                <span class="badge bg-yellow">مرفوض</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Waiting)
                            {
                                <span class="badge bg-orange">مؤجل</span>
                            }
                            else if (order.Status == PostexS.Models.Enums.OrderStatus.Completed)
                            {
                                <span class="badge bg-light-blue">تم تسويته</span>
                            }
                        </h4>
                    </div>
                </div>
                <div>
                    <table class="table text-center table-bordered" dir="rtl">
                        <tbody>
                            <tr>
                                <td style="width:38%">
                                    <span>الراسل</span>
                                    <br />
                                    <p>@order.Client.Name</p>
                                    <p>الفرع :  @order.Branch.Name </p>
                                    <p>الهاتف :  <a dir="auto" href="tel:@order.Client.PhoneNumber">@order.Client.PhoneNumber</a> </p>
                                    <p>العنوان : @order.Client.Address</p>
                                </td>
                                <td style="width:20%">
                                    <img src="~/Content/Images/TasahelExpress.png" width="150" height="110" />
                                    @* <h5 style="text-align:center;margin-top: 5px !important;margin-bottom: 5px !important;">01212830787</h5> *@
                                    <h5 style="text-align:center;margin-top: 5px !important;margin-bottom: 5px !important;">01044577578</h5>
                                </td>
                                <td style="width:42%">
                                    <span>المرسل إليه</span>
                                    <br />
                                    <p class="badge">@order.ClientCode</p>
                                    <p>@order.ClientName</p>
                                    <p>الهاتف :  <a dir="auto" href="tel:@order.ClientPhone">@order.ClientPhone</a> </p>
                                    <p>العنوان : @order.AddressCity - @order.Address</p>
                                </td>
                                <td><input class="check-box no-print" type="checkbox" name="Orders" value="@order.Id" /></td>
                            </tr>
                            <tr>
                                <td>
                                    ملاحظات
                                </td>
                                <td>
                                    <span>الاجمالي : @order.TotalCost جنية</span>
                                </td>
                                <td style="font-size: 12px;">
                                    @order.Notes
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </form>
    <a href="/Orders/Index" class="btn btn-default no-print">العودة</a>
</div>
@section Scripts {
    <script>
        var orderIds = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(o => o.Id).ToList()));
        console.log("Order IDs:", orderIds); // للتأكد من القيم في console
    </script>
    <script>
                function markAndPrint(type, size) {
            console.log("Order IDs to print:", orderIds); // للتأكد من القيم

            if (!orderIds || orderIds.length === 0) {
                alert('لا توجد طلبات محددة للطباعة');
                return;
            }

            $.ajax({
                type: 'POST',
                url: '/Orders/MarkAsPrinted',
                contentType: 'application/json',
                data: JSON.stringify(orderIds),
                success: function (data) {
                    if (data.success) {
                        if (type === 'normal') {
                            window.print();
                        } else {
                            printThermal(size || '10x10');
                        }
                    } else {
                        alert('خطأ في تحديث حالة الطباعة: ' + (data.message || ''));
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error, xhr.responseText);
                    alert('خطأ في الاتصال بالسيرفر: ' + error);
                }
            });
        }

            function printThermal(size) {
                var originalContent = document.body.innerHTML;
                var thermalContents = '';
                
                // تحديد المقاسات
                var sizes = {
                    '7.5x13': { width: '75mm', height: '130mm', pageSize: '75mm 130mm' },
                    '10x10': { width: '100mm', height: '100mm', pageSize: '100mm 100mm' },
                    '10x15': { width: '100mm', height: '150mm', pageSize: '100mm 150mm' }
                };
                
                var selectedSize = sizes[size] || sizes['10x10'];
                var fontSize = size === '7.5x13' ? '12px' : (size === '10x10' ? '11px' : '14px');
                var logoWidth = size === '7.5x13' ? '35mm' : (size === '10x10' ? '30mm' : '40mm');
                var logoHeight = size === '7.5x13' ? '15mm' : (size === '10x10' ? '12mm' : '20mm');
                var barcodeWidth = size === '7.5x13' ? '60mm' : (size === '10x10' ? '85mm' : '130mm');
                var barcodeHeight = size === '7.5x13' ? '10mm' : (size === '10x10' ? '10mm' : '12mm');
                var padding = size === '10x10' ? '1.5mm' : '2mm';
                var marginBottom = size === '10x10' ? '2px' : '5px';
                
                // Add style tag once at the beginning
                thermalContents += `
                    <style>
                        @@media print {
                            @@page {
                                size: ${selectedSize.pageSize};
                                margin: 0;
                            }
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            body {
                                width: ${selectedSize.width};
                                height: ${selectedSize.height};
                                margin: 0;
                                padding: 0;
                                overflow: hidden;
                            }
                        }
                    </style>
                `;
                
                var orders = [
                    @foreach (var order in Model)
                    {
                            var CreatedOn = TimeZoneInfo.ConvertTimeFromUtc(order.CreateOn, TimeZoneInfo.FindSystemTimeZoneById("Egypt Standard Time"));
                            <text>
                            {
                                CreatedOn: '@CreatedOn.ToString("yyyy/MM/dd hh:mm tt")',
                                BarcodeImage: '@(order.BarcodeImage != null ? Convert.ToBase64String(order.BarcodeImage) : "")',
                                Code: '@order.Code',
                                ClientName: '@order.Client.Name',
                                BranchName: '@order.Branch.Name',
                                ClientPhone: '@order.Client.PhoneNumber',
                                ClientAddress: '@order.Client.Address',
                                ReceiverName: '@order.ClientName',
                                ClientCode: '@order.ClientCode',
                                ReceiverPhone: '@order.ClientPhone',
                                Address: '@order.AddressCity - @order.Address',
                                Status: '@order.Status',
                                IsDeleted: @order.IsDeleted.ToString().ToLower(),
                                Cost: '@order.Cost',
                                DeliveryFees: '@order.DeliveryFees',
                                TotalCost: '@order.TotalCost',
                                ArrivedCost: '@(order.Status == PostexS.Models.Enums.OrderStatus.PartialDelivered ? order.ArrivedCost.ToString() : "")',
                                ReturnedCost: '@(order.Status == PostexS.Models.Enums.OrderStatus.PartialDelivered ? order.ReturnedCost.ToString() : "")',
                                Notes: '@order.Notes',
                                OrderNotes: [
                                    @foreach (var note in order.OrderNotes)
                                    {
                                            <text>'@note.Content',</text>
                                    }
                                ]
                            },
                            </text>
                    }
                ];

                orders.forEach(function(order, index) {
                    var isLastOrder = index === orders.length - 1;

                    thermalContents += `
                        <div style="width:${selectedSize.width}; height:${selectedSize.height}; margin:0; padding:${padding}; font-size:${fontSize}; font-family:Arial; line-height:1.3; direction:rtl; position:relative; border:2px solid #000; box-sizing:border-box; overflow:hidden; ${!isLastOrder ? 'page-break-after: always' : ''}">
                            <!-- Logo Inside Border - Centered -->
                            <div style="text-align:center; margin:0;">
                                <img src="@Url.Content("~/Content/Images/TasahelExpress.png")" style="width:${logoWidth}; max-height:${logoHeight}; object-fit:contain;" />
                            </div>
                            <!-- Date and Barcode Section - Centered -->
                            <div style="text-align:center; margin-bottom:${marginBottom};">
                                <div style="font-size:${fontSize}; margin-bottom:2px;">${order.CreatedOn}</div>
                                ${order.BarcodeImage ? `
                                    <div style="text-align:center; margin-top:2px;">
                                        <img src="data:image/png;base64,${order.BarcodeImage}" alt="Barcode" style="width:${barcodeWidth}; max-height:${barcodeHeight}; object-fit:contain; display:block; margin:0 auto;">
                                    </div>
                                ` : ''}
                            </div>

                            <hr style="border-top:2px solid #000; margin:${marginBottom} 0;">

                            <!-- Client Code Section - Right Aligned -->
                            <div style="text-align:right; margin-bottom:${marginBottom};">
                                <div style="font-size:${fontSize}; font-weight:bold;">كود العميل: ${order.ClientCode || '0'}</div>
                            </div>

                            <hr style="border-top:2px solid #000; margin:${marginBottom} 0;">

                            <!-- Recipient Information Section -->
                            <div style="margin-bottom:${marginBottom};">
                                <div><strong>المرسل اليه:</strong> ${order.ReceiverName}</div>
                                <div><strong>الهاتف:</strong> ${order.ReceiverPhone}</div>
                                <div><strong>العنوان:</strong> ${order.Address}</div>
                            </div>

                            <hr style="border-top:2px solid #000; margin:${marginBottom} 0;">

                            <!-- Notes Section with Vertical Barcode -->
                            <div style="margin-bottom:${marginBottom}; border:2px solid #000; padding:2px; min-height:${size === '10x10' ? '12mm' : '15mm'}; position:relative;">
                                <div style="margin-left:18mm;">
                                    <div><strong>الملاحظات:</strong></div>
                                    ${order.Notes ? `
                                        <div style="word-wrap:break-word; font-size:${fontSize}; margin-top:2px;">${order.Notes}</div>
                                    ` : ''}
                                    ${order.OrderNotes.filter(note => note).map(note => `
                                        <div style="word-wrap:break-word; font-size:${fontSize}; margin-top:2px;">${note}</div>
                                    `).join('')}
                                    ${!order.Notes && order.OrderNotes.filter(note => note).length === 0 ? `
                                        <div style="font-size:${fontSize}; margin-top:2px;">لا توجد ملاحظات</div>
                                    ` : ''}
                                </div>
                                ${order.BarcodeImage ? `
                                    <div style="position:absolute; left:2px; top:2px; bottom:2px; display:flex; flex-direction:column; align-items:center; justify-content:center; border-right:1px solid #ddd; padding-right:2px;">
                                        <img src="data:image/png;base64,${order.BarcodeImage}" alt="Barcode" style="height:calc(100% - 10px); max-height:calc(100% - 10px); width:16mm; object-fit:contain; transform:rotate(-90deg);" />
                                    </div>
                                ` : ''}
                            </div>

                            <hr style="border-top:2px solid #000; margin:${marginBottom} 0;">

                            <!-- Financial Summary and Sender Information -->
                            <div style="display:flex; justify-content:space-between; margin-top:${marginBottom};">
                                <!-- Sender Information -->
                                <div style="flex:1; margin-left:5px;">
                                    <div><strong>الراسل:</strong> ${order.ClientName}${order.BranchName ? ' - ' + order.BranchName : ''}</div>
                                    <div><strong>الهاتف:</strong> ${order.ClientPhone}</div>
                                </div>
                                <!-- Financial Summary Table -->
                                <div style="flex:1; border:2px solid #000; padding:3px;">
                                    <table style="width:100%; border-collapse:collapse; font-size:${fontSize};">
                                        <tr>
                                            <td style="padding:2px; border-bottom:2px solid #000;"><strong>سعر الطلب</strong></td>
                                            <td style="padding:2px; border-bottom:2px solid #000; text-align:left;">${order.Cost}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding:2px; border-bottom:2px solid #000;"><strong>الشحن</strong></td>
                                            <td style="padding:2px; border-bottom:2px solid #000; text-align:left;">${order.DeliveryFees}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding:2px;"><strong>الاجمالي</strong></td>
                                            <td style="padding:2px; text-align:left;"><strong>${order.TotalCost}</strong></td>
                                        </tr>
                                        ${order.ArrivedCost ? `
                                            <tr>
                                                <td style="padding:2px; border-top:2px solid #000;"><strong>إستلام</strong></td>
                                                <td style="padding:2px; border-top:2px solid #000; text-align:left;">${order.ArrivedCost}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding:2px;"><strong>مرتجع</strong></td>
                                                <td style="padding:2px; text-align:left;">${order.ReturnedCost}</td>
                                            </tr>
                                        ` : ''}
                                    </table>
                                </div>
                            </div>

                            <!-- Footer -->
                            <div style="text-align:center; margin-top:${marginBottom}; font-size:${fontSize}; border-top:2px solid #000; padding-top:2px;">
                                <div>خدمة العملاء 01044577578</div>
                            </div>
                        </div>
                    `;
                });

                // Replace page content with all thermal contents
                document.body.innerHTML = thermalContents;

                // Delay printing to ensure content loads
                setTimeout(function() {
                    window.print();
                    // Restore original content after printing
                    document.body.innerHTML = originalContent;
                }, 500);

                function getStatusText(order) {
                    if (order.IsDeleted) return 'محذوف';
                    switch(order.Status) {
                        case 'Placed': return 'جديد';
                        case 'PartialReturned': return 'مرتجع جزئي';
                        case 'Returned': return 'مرتجع كامل';
                        case 'Returned_And_DeliveryCost_On_Sender': return 'مرتجع وشحن على الراسل';
                        case 'Returned_And_Paid_DeliveryCost': return 'مرتجع ودفع شحن';
                        case 'Delivered_With_Edit_Price': return 'تم التوصيل مع تعديل السعر';
                        case 'PartialDelivered': return 'تم التوصيل جزئي';
                        case 'Assigned': return 'جارى التوصيل';
                        case 'Delivered': return 'تم التوصيل';
                        case 'Rejected': return 'مرفوض';
                        case 'Waiting': return 'مؤجل';
                        case 'Completed': return 'تم تسويته';
                        default: return '';
                    }
                }
            }
    </script>
}