@model PostexS.Models.ViewModels.WhatsAppSettingsViewModel
@using PostexS.Models.ViewModels
@using PostexS.Models.Enums
@{
    ViewData["Title"] = "Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨";
}

<style>
    .provider-tab {
        cursor: pointer;
        padding: 15px 20px;
        border: 2px solid #ddd;
        border-radius: 5px 5px 0 0;
        background: #f5f5f5;
        margin-right: 5px;
        display: inline-block;
        transition: all 0.3s;
    }
    .provider-tab.active {
        background: #337ab7;
        color: white;
        border-color: #337ab7;
    }
    .provider-tab:hover {
        background: #e0e0e0;
    }
    .provider-tab.active:hover {
        background: #286090;
    }
    .provider-content {
        display: none;
        padding: 20px;
        border: 2px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        background: white;
    }
    .provider-content.active {
        display: block;
    }
    .groups-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 10px;
    }
    .group-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background 0.2s;
    }
    .group-item:hover {
        background: #f0f8ff;
    }
    .group-item.selected {
        background: #d4edda;
        border-left: 4px solid #28a745;
    }
    .group-item:last-child {
        border-bottom: none;
    }
    .group-name {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    .group-id {
        font-size: 12px;
        color: #666;
        font-family: monospace;
    }
    .group-search {
        margin-bottom: 10px;
    }
</style>

<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-cog"></i> @ViewData["Title"]</h3>
    </div>
    <div class="panel-body">

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                @TempData["Success"]
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                @TempData["Error"]
            </div>
        }

        <!-- Provider Switch -->
        <div class="panel panel-default" style="margin-bottom: 20px;">
            <div class="panel-heading">
                <h4 class="panel-title"><i class="fa fa-exchange"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ø²ÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨</h4>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="control-label">Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·:</label>
                            <div class="btn-group" data-toggle="buttons" id="providerSwitch" style="margin-top: 10px;">
                                <label class="btn btn-lg @(Model.ActiveProvider == WhatsAppProvider.Wapilot ? "btn-success active" : "btn-default")" data-provider="@((int)WhatsAppProvider.Wapilot)">
                                    <input type="radio" name="provider" value="@((int)WhatsAppProvider.Wapilot)" @(Model.ActiveProvider == WhatsAppProvider.Wapilot ? "checked" : "") autocomplete="off">
                                    <i class="fa fa-server"></i> Server 1 (Wapilot)
                                </label>
                                <label class="btn btn-lg @(Model.ActiveProvider == WhatsAppProvider.WhatsAppBotCloud ? "btn-success active" : "btn-default")" data-provider="@((int)WhatsAppProvider.WhatsAppBotCloud)">
                                    <input type="radio" name="provider" value="@((int)WhatsAppProvider.WhatsAppBotCloud)" @(Model.ActiveProvider == WhatsAppProvider.WhatsAppBotCloud ? "checked" : "") autocomplete="off">
                                    <i class="fa fa-cloud"></i> Server 2 (WhatsApp Cloud)
                                </label>
                            </div>
                            <small class="text-muted" style="display: block; margin-top: 10px;">
                                Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ù†Ø´Ø· Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. Server 1 (Wapilot) Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Server 2 (WhatsApp Cloud) Ù„Ù„Ø¬Ø±ÙˆØ¨Ø§Øª.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row" style="margin-bottom: 20px;">
            <div class="col-md-3 col-sm-6">
                <div class="panel panel-info">
                    <div class="panel-heading text-center">
                        <i class="fa fa-clock-o fa-2x"></i>
                        <h4>@(Model.Statistics?.PendingCount ?? 0)</h4>
                        <small>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="panel panel-success">
                    <div class="panel-heading text-center">
                        <i class="fa fa-check fa-2x"></i>
                        <h4>@(Model.Statistics?.SentTodayCount ?? 0)</h4>
                        <small>ØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="panel panel-danger">
                    <div class="panel-heading text-center">
                        <i class="fa fa-times fa-2x"></i>
                        <h4>@(Model.Statistics?.FailedTodayCount ?? 0)</h4>
                        <small>ÙØ´Ù„ Ø§Ù„ÙŠÙˆÙ…</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="panel panel-warning">
                    <div class="panel-heading text-center">
                        <i class="fa fa-paper-plane fa-2x"></i>
                        <h4>@(Model.Statistics?.TotalSentCount ?? 0)</h4>
                        <small>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø³Ù„</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Provider Tabs -->
        <div style="margin-bottom: 20px;">
            <div class="provider-tabs" style="border-bottom: 2px solid #ddd; padding-bottom: 0;">
                <div class="provider-tab active" data-provider="Wapilot">
                    <i class="fa fa-server"></i> Server 1 (Wapilot)
                </div>
                <div class="provider-tab" data-provider="WhatsAppBotCloud">
                    <i class="fa fa-cloud"></i> Server 2 (WhatsApp Cloud)
                </div>
            </div>

            <!-- Wapilot Settings -->
            <div class="provider-content active" id="WapilotContent">
                @using (Html.BeginForm("Index", "WapilotSettings", FormMethod.Post, new { @class = "form-horizontal" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.Hidden("providerType", "Wapilot")
                    @Html.HiddenFor(m => m.WapilotSettings.Id)
                    @Html.HiddenFor(m => m.WapilotSettings.CreateOn)
                    @Html.HiddenFor(m => m.WapilotSettings.IsDeleted)

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title"><i class="fa fa-cogs"></i> Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª Wapilot API</h4>
                        </div>
                        <div class="panel-body">
                            @Html.ValidationSummary(false, "", new { @class = "text-danger" })

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Base URL</label>
                                        @Html.TextBoxFor(m => m.WapilotSettings.BaseUrl, new { @class = "form-control", placeholder = "https://message-pro.com/api/v1/" })
                                        <small class="text-muted">Ø±Ø§Ø¨Ø· API Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Instance ID</label>
                                        @Html.TextBoxFor(m => m.WapilotSettings.InstanceId, new { @class = "form-control", placeholder = "instance3067" })
                                        <small class="text-muted">Ù…Ø¹Ø±Ù Ø§Ù„Ù€ Instance Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">API Token</label>
                                        @Html.TextBoxFor(m => m.WapilotSettings.ApiToken, new { @class = "form-control", placeholder = "Ø§Ø¯Ø®Ù„ Ø§Ù„Ù€ Token" })
                                        <small class="text-muted">Ø±Ù…Ø² Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ API</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)</label>
                                        @Html.TextBoxFor(m => m.WapilotSettings.MessageIntervalSeconds, new { @class = "form-control", type = "number", min = "5", max = "3600" })
                                        <small class="text-muted">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¯Ù†Ù‰ 5 Ø«ÙˆØ§Ù†ÙŠ - ÙŠÙØ¶Ù„ 30-60 Ø«Ø§Ù†ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Ø­Ø§Ù„Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø§Ø±Ø³Ø§Ù„</label>
                                        @Html.HiddenFor(m => m.WapilotSettings.IsActive)
                                        <div style="margin-top: 5px;">
                                            @if (Model.WapilotSettings.IsActive)
                                            {
                                                <button type="button" class="btn btn-success btn-lg btnToggleWapilot" data-active="true">
                                                    <i class="fa fa-power-off"></i> Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ÙØ¹Ù„Ø© - Ø§Ø¶ØºØ· Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-danger btn-lg btnToggleWapilot" data-active="false">
                                                    <i class="fa fa-power-off"></i> Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ØªÙˆÙ‚ÙØ© - Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ¹ÙŠÙ„
                                                </button>
                                            }
                                        </div>
                                        <small class="text-muted">Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ Ù„Ù† ÙŠØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù†Ø¯ ØªÙ‚ÙÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fa fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª
                                </button>
                                <a href="@Url.Action("Queue")" class="btn btn-info btn-lg">
                                    <i class="fa fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                                </a>
                                <a href="@Url.Action("Logs")" class="btn btn-warning btn-lg">
                                    <i class="fa fa-history"></i> Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                                </a>
                            </div>
                        </div>
                    </div>
                }

                <!-- Wapilot Test Section -->
                <div class="panel panel-default" style="margin-top: 20px;">
                    <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-flask"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø±Ø³Ø§Ù„ - Wapilot</h4>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fa fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø±Ù‚Ù…</h5>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø¯ÙˆÙ† +)</label>
                                    <input type="text" id="wapilotTestPhoneNumber" class="form-control" placeholder="201012345678" />
                                </div>
                                <div class="form-group">
                                    <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                                    <textarea id="wapilotTestMessage" class="form-control" rows="3" placeholder="Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©"></textarea>
                                </div>
                                <button type="button" id="btnSendWapilotTest" class="btn btn-primary">
                                    <i class="fa fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø±Ù‚Ù…
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fa fa-users"></i> Ø§Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ø±ÙˆØ¨</h5>
                                <div class="form-group">
                                    <label>Group ID (Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨)</label>
                                    <input type="text" id="wapilotTestGroupId" class="form-control" placeholder="120363XXXXXXXXXX@@g.us" />
                                </div>
                                <div class="form-group">
                                    <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                                    <textarea id="wapilotTestGroupMessage" class="form-control" rows="3" placeholder="Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø¬Ø±ÙˆØ¨"></textarea>
                                </div>
                                <button type="button" id="btnSendWapilotTestGroup" class="btn btn-success">
                                    <i class="fa fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ø±ÙˆØ¨
                                </button>
                            </div>
                        </div>
                        <div id="wapilotTestResult" class="alert" style="display:none; margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Bot Cloud Settings -->
            <div class="provider-content" id="WhatsAppBotCloudContent">
                @using (Html.BeginForm("Index", "WapilotSettings", FormMethod.Post, new { @class = "form-horizontal" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.Hidden("providerType", "WhatsAppBotCloud")
                    @Html.HiddenFor(m => m.WhatsAppBotCloudSettings.Id)
                    @Html.HiddenFor(m => m.WhatsAppBotCloudSettings.CreateOn)
                    @Html.HiddenFor(m => m.WhatsAppBotCloudSettings.IsDeleted)

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title"><i class="fa fa-cloud"></i> Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª WhatsApp Bot Cloud API</h4>
                        </div>
                        <div class="panel-body">
                            @Html.ValidationSummary(false, "", new { @class = "text-danger" })

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Base URL</label>
                                        @Html.TextBoxFor(m => m.WhatsAppBotCloudSettings.BaseUrl, new { @class = "form-control", placeholder = "https://whatsbotcloud.com/api/" })
                                        <small class="text-muted">Ø±Ø§Ø¨Ø· API Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Instance ID</label>
                                        @Html.TextBoxFor(m => m.WhatsAppBotCloudSettings.InstanceId, new { @class = "form-control", placeholder = "instance3067" })
                                        <small class="text-muted">Ù…Ø¹Ø±Ù Ø§Ù„Ù€ Instance Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Access Token</label>
                                        @Html.TextBoxFor(m => m.WhatsAppBotCloudSettings.AccessToken, new { @class = "form-control", placeholder = "Ø§Ø¯Ø®Ù„ Ø§Ù„Ù€ Access Token" })
                                        <small class="text-muted">Ø±Ù…Ø² Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ API</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)</label>
                                        @Html.TextBoxFor(m => m.WhatsAppBotCloudSettings.MessageIntervalSeconds, new { @class = "form-control", type = "number", min = "5", max = "3600" })
                                        <small class="text-muted">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¯Ù†Ù‰ 5 Ø«ÙˆØ§Ù†ÙŠ - ÙŠÙØ¶Ù„ 30-60 Ø«Ø§Ù†ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Ø­Ø§Ù„Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø§Ø±Ø³Ø§Ù„</label>
                                        @Html.HiddenFor(m => m.WhatsAppBotCloudSettings.IsActive)
                                        <div style="margin-top: 5px;">
                                            @if (Model.WhatsAppBotCloudSettings.IsActive)
                                            {
                                                <button type="button" class="btn btn-success btn-lg btnToggleBotCloud" data-active="true">
                                                    <i class="fa fa-power-off"></i> Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ÙØ¹Ù„Ø© - Ø§Ø¶ØºØ· Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-danger btn-lg btnToggleBotCloud" data-active="false">
                                                    <i class="fa fa-power-off"></i> Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ØªÙˆÙ‚ÙØ© - Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ¹ÙŠÙ„
                                                </button>
                                            }
                                        </div>
                                        <small class="text-muted">Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ Ù„Ù† ÙŠØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù†Ø¯ ØªÙ‚ÙÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fa fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª
                                </button>
                            </div>
                        </div>
                    </div>
                }

                <!-- WhatsApp Bot Cloud Test Section -->
                <div class="panel panel-default" style="margin-top: 20px;">
                    <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-flask"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø±Ø³Ø§Ù„ - WhatsApp Bot Cloud</h4>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fa fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø±Ù‚Ù…</h5>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø¯ÙˆÙ† +)</label>
                                    <input type="text" id="botCloudTestPhoneNumber" class="form-control" placeholder="201012345678" />
                                </div>
                                <div class="form-group">
                                    <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                                    <textarea id="botCloudTestMessage" class="form-control" rows="3" placeholder="Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©"></textarea>
                                </div>
                                <button type="button" id="btnSendBotCloudTest" class="btn btn-primary">
                                    <i class="fa fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø±Ù‚Ù…
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fa fa-users"></i> Ø§Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ø±ÙˆØ¨</h5>
                                <div class="form-group">
                                    <label>Group ID (Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨)</label>
                                    <div class="input-group">
                                        <input type="text" id="botCloudTestGroupId" class="form-control" placeholder="120363XXXXXXXXXX@@g.us" />
                                        <span class="input-group-btn">
                                            <button type="button" id="btnLoadBotCloudGroups" class="btn btn-info">
                                                <i class="fa fa-refresh"></i> Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ø±ÙˆØ¨Ø§Øª
                                            </button>
                                        </span>
                                    </div>
                                    <div class="group-search" style="margin-top: 10px;">
                                        <input type="text" id="botCloudGroupSearch" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ø±ÙˆØ¨..." style="display: none;" />
                                    </div>
                                    <div id="botCloudGroupsList" class="groups-list" style="display: none;"></div>
                                </div>
                                <div class="form-group">
                                    <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                                    <textarea id="botCloudTestGroupMessage" class="form-control" rows="3" placeholder="Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø¬Ø±ÙˆØ¨"></textarea>
                                </div>
                                <button type="button" id="btnSendBotCloudTestGroup" class="btn btn-success">
                                    <i class="fa fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ø±ÙˆØ¨
                                </button>
                            </div>
                        </div>
                        <div id="botCloudTestResult" class="alert" style="display:none; margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- Background Send Test Section - WhatsApp Bot Cloud -->
                <div class="panel panel-warning" style="margin-top: 20px;">
                    <div class="panel-heading">
                        <h4 class="panel-title"><i class="fa fa-cogs"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Background Task)</h4>
                    </div>
                    <div class="panel-body">
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i>
                            <strong>Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ­Ø§ÙƒÙŠ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ ØªÙ‚ÙÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</strong> - ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¢Ù„ÙŠØ© Ø§Ù„Ù€ Fire-and-Forget Ù…Ø¹ Scoped Services
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fa fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ø±Ù‚Ù… (Background)</h5>
                                <div class="form-group">
                                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø¯ÙˆÙ† +)</label>
                                    <input type="text" id="bgTestPhoneNumber" class="form-control" placeholder="201012345678" />
                                </div>
                                <div class="form-group">
                                    <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                                    <textarea id="bgTestPhoneMessage" class="form-control" rows="3" placeholder="Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©">ğŸ§ª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</textarea>
                                </div>
                                <button type="button" id="btnBgSendToPhone" class="btn btn-warning btn-lg">
                                    <i class="fa fa-rocket"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø±Ù‚Ù… (Background)
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fa fa-users"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ø¬Ø±ÙˆØ¨ (Background)</h5>
                                <div class="form-group">
                                    <label>Group ID (Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨)</label>
                                    <input type="text" id="bgTestGroupId" class="form-control" placeholder="120363XXXXXXXXXX@@g.us" />
                                </div>
                                <div class="form-group">
                                    <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                                    <textarea id="bgTestGroupMessage" class="form-control" rows="3" placeholder="Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø¬Ø±ÙˆØ¨">ğŸ§ª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</textarea>
                                </div>
                                <button type="button" id="btnBgSendToGroup" class="btn btn-warning btn-lg">
                                    <i class="fa fa-rocket"></i> Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ø±ÙˆØ¨ (Background)
                                </button>
                            </div>
                        </div>
                        <div id="backgroundTestResult" class="alert" style="display:none; margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            var allBotCloudGroups = [];
            var selectedBotCloudGroupId = '';

            // Provider Switch
            $('#providerSwitch label').click(function () {
                var provider = $(this).data('provider');
                var btn = $(this);
                
                $.post('@Url.Action("UpdateProvider")', { provider: provider }, function (response) {
                    if (response.success) {
                        $('#providerSwitch label').removeClass('btn-success active').addClass('btn-default');
                        btn.removeClass('btn-default').addClass('btn-success active');
                        $('#providerSwitch input[type="radio"]').prop('checked', false);
                        btn.find('input[type="radio"]').prop('checked', true);
                        
                        showResult('provider', true, response.message);
                    } else {
                        showResult('provider', false, response.message);
                    }
                }).fail(function () {
                    showResult('provider', false, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø²ÙˆØ¯');
                });
            });

            // Provider Tabs
            $('.provider-tab').click(function () {
                var provider = $(this).data('provider');
                $('.provider-tab').removeClass('active');
                $(this).addClass('active');
                $('.provider-content').removeClass('active');
                $('#' + provider + 'Content').addClass('active');
            });

            // Toggle Wapilot Service
            $('.btnToggleWapilot').click(function () {
                var btn = $(this);
                var isActive = btn.data('active');
                var newState = !isActive;
                $('#WapilotSettings_IsActive').val(newState.toString());
                updateToggleButton(btn, newState);
            });

            // Toggle Bot Cloud Service
            $('.btnToggleBotCloud').click(function () {
                var btn = $(this);
                var isActive = btn.data('active');
                var newState = !isActive;
                $('#WhatsAppBotCloudSettings_IsActive').val(newState.toString());
                updateToggleButton(btn, newState);
            });

            function updateToggleButton(btn, newState) {
                if (newState) {
                    btn.removeClass('btn-danger').addClass('btn-success');
                    btn.html('<i class="fa fa-power-off"></i> Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ÙØ¹Ù„Ø© - Ø§Ø¶ØºØ· Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù');
                } else {
                    btn.removeClass('btn-success').addClass('btn-danger');
                    btn.html('<i class="fa fa-power-off"></i> Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ØªÙˆÙ‚ÙØ© - Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ¹ÙŠÙ„');
                }
                btn.data('active', newState);
            }

            // Wapilot Test Messages
            $('#btnSendWapilotTest').click(function () {
                var phone = $('#wapilotTestPhoneNumber').val();
                var message = $('#wapilotTestMessage').val();
                if (!phone || !message) {
                    showResult('wapilot', false, 'Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©');
                    return;
                }
                sendTest('@Url.Action("SendTestMessage")', { phoneNumber: phone, message: message }, $(this), 'wapilot');
            });

            $('#btnSendWapilotTestGroup').click(function () {
                var groupId = $('#wapilotTestGroupId').val().trim();
                var message = $('#wapilotTestGroupMessage').val();
                if (!groupId || !message) {
                    showResult('wapilot', false, 'Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©');
                    return;
                }
                if (!groupId.endsWith('@@g.us')) {
                    showResult('wapilot', false, 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @@g.us');
                    return;
                }
                sendTest('@Url.Action("SendTestToGroupById")', { groupId: groupId, message: message }, $(this), 'wapilot');
            });

            // Bot Cloud Load Groups
            $('#btnLoadBotCloudGroups').click(function () {
                var btn = $(this);
                var originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...');

                $.post('@Url.Action("GetGroupsForWhatsAppBotCloud")', {}, function (response) {
                    if (response.success && response.groups && response.groups.length > 0) {
                        allBotCloudGroups = response.groups;
                        renderBotCloudGroups(allBotCloudGroups);
                        $('#botCloudGroupsList').show();
                        $('#botCloudGroupSearch').show();
                        showResult('botCloud', true, response.message);
                    } else {
                        showResult('botCloud', false, response.message || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø±ÙˆØ¨Ø§Øª');
                        $('#botCloudGroupsList').hide();
                        $('#botCloudGroupSearch').hide();
                    }
                    btn.prop('disabled', false).html(originalHtml);
                }).fail(function () {
                    showResult('botCloud', false, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ø±ÙˆØ¨Ø§Øª');
                    btn.prop('disabled', false).html(originalHtml);
                });
            });

            // Bot Cloud Search Groups
            $('#botCloudGroupSearch').on('input', function () {
                var searchTerm = $(this).val().toLowerCase();
                if (allBotCloudGroups.length === 0) return;
                
                var filtered = allBotCloudGroups.filter(function (g) {
                    return (g.name && g.name.toLowerCase().includes(searchTerm)) ||
                           (g.id && g.id.toLowerCase().includes(searchTerm));
                });
                renderBotCloudGroups(filtered);
            });

            // Render Bot Cloud Groups
            function renderBotCloudGroups(groups) {
                var list = $('#botCloudGroupsList');
                list.empty();

                if (groups.length === 0) {
                    list.append('<div class="group-item text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø±ÙˆØ¨Ø§Øª</div>');
                    return;
                }

                groups.forEach(function (group) {
                    var item = $('<div class="group-item" data-group-id="' + group.id + '">' +
                        '<div class="group-name">' + (group.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…') + '</div>' +
                        '<div class="group-id">' + group.id + '</div>' +
                        '</div>');

                    if (group.id === selectedBotCloudGroupId) {
                        item.addClass('selected');
                    }

                    item.click(function () {
                        $('.group-item').removeClass('selected');
                        $(this).addClass('selected');
                        selectedBotCloudGroupId = group.id;
                        $('#botCloudTestGroupId').val(group.id);
                    });

                    list.append(item);
                });
            }

            // Bot Cloud Test Messages
            $('#btnSendBotCloudTest').click(function () {
                var phone = $('#botCloudTestPhoneNumber').val();
                var message = $('#botCloudTestMessage').val();
                if (!phone || !message) {
                    showResult('botCloud', false, 'Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©');
                    return;
                }
                sendTest('@Url.Action("SendTestMessageWhatsAppBotCloud")', { phoneNumber: phone, message: message }, $(this), 'botCloud');
            });

            $('#btnSendBotCloudTestGroup').click(function () {
                var groupId = $('#botCloudTestGroupId').val().trim();
                var message = $('#botCloudTestGroupMessage').val();
                if (!groupId || !message) {
                    showResult('botCloud', false, 'Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©');
                    return;
                }
                sendTest('@Url.Action("SendTestGroupMessageWhatsAppBotCloud")', { groupId: groupId, message: message }, $(this), 'botCloud');
            });

            function sendTest(url, data, btn, provider) {
                var originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø±Ø³Ø§Ù„...');

                $.post(url, data, function (response) {
                    showResult(provider, response.success, response.message + (response.duration ? ' (' + response.duration + 'ms)' : ''));
                    btn.prop('disabled', false).html(originalHtml);
                }).fail(function () {
                    showResult(provider, false, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø§Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø±Ø³Ø§Ù„');
                    btn.prop('disabled', false).html(originalHtml);
                });
            }

            // Background Task Test - Send to Phone
            $('#btnBgSendToPhone').click(function () {
                var phone = $('#bgTestPhoneNumber').val();
                var message = $('#bgTestPhoneMessage').val();
                if (!phone || !message) {
                    showResult('background', false, 'Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©');
                    return;
                }

                var btn = $(this);
                var originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

                $.post('@Url.Action("TestBackgroundSendToPhone")', { phoneNumber: phone, message: message }, function (response) {
                    showResult('background', response.success, response.message);
                    btn.prop('disabled', false).html(originalHtml);
                }).fail(function (xhr) {
                    var errMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
                    showResult('background', false, errMsg);
                    btn.prop('disabled', false).html(originalHtml);
                });
            });

            // Background Task Test - Send to Group
            $('#btnBgSendToGroup').click(function () {
                var groupId = $('#bgTestGroupId').val().trim();
                var message = $('#bgTestGroupMessage').val();
                if (!groupId || !message) {
                    showResult('background', false, 'Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©');
                    return;
                }
                if (!groupId.endsWith('@@g.us')) {
                    showResult('background', false, 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø±ÙˆØ¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @@g.us');
                    return;
                }

                var btn = $(this);
                var originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...');

                $.post('@Url.Action("TestBackgroundSendToGroup")', { groupId: groupId, message: message }, function (response) {
                    showResult('background', response.success, response.message);
                    btn.prop('disabled', false).html(originalHtml);
                }).fail(function (xhr) {
                    var errMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
                    showResult('background', false, errMsg);
                    btn.prop('disabled', false).html(originalHtml);
                });
            });

            function showResult(provider, success, message) {
                var resultDiv = provider === 'wapilot' ? $('#wapilotTestResult') :
                               provider === 'botCloud' ? $('#botCloudTestResult') :
                               provider === 'background' ? $('#backgroundTestResult') :
                               $('#providerResult');
                resultDiv.removeClass('alert-success alert-danger');
                resultDiv.addClass(success ? 'alert-success' : 'alert-danger');
                resultDiv.html('<i class="fa fa-' + (success ? 'check' : 'times') + '"></i> ' + message).show();
            }
        });
    </script>
}
