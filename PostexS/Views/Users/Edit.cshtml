@using PostexS.Models.Enums
@using System.ComponentModel.DataAnnotations
@model PostexS.Models.Domain.ApplicationUser
@{
    ViewBag.Title = "تعديل المستخدم  " + Model.Name;
    var branchs = ViewBag.Branchs as List<PostexS.Models.Domain.Branch>;
}
<style>
    .form-group {
        display: flex;
        align-items: center;
    }

        .form-group label {
            margin-right: 10px;
            font-weight: bold;
        }

    .button-group {
        display: flex;
        justify-content: space-between;
        width: 100%;
    }

        .button-group button {
            flex: 1;
            margin: 0 5px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            cursor: pointer;
        }

            .button-group button:hover {
                background-color: #ddd;
            }

            .button-group button.active {
                background-color: #bdb133;
                color: white;
            }

            .button-group button:first-child {
                border-top-left-radius: 5px;
                border-bottom-left-radius: 5px;
            }

            .button-group button:last-child {
                border-top-right-radius: 5px;
                border-bottom-right-radius: 5px;
            }

    /* WhatsApp Groups Styling */
    .whatsapp-group-container {
        position: relative;
        margin-top: 10px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .group-search-wrapper {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: stretch;
    }

    .group-search-wrapper .form-control {
        flex: 1;
        border-radius: 6px;
        border: 2px solid #e0e0e0;
        transition: all 0.3s ease;
        padding: 12px 15px;
        font-size: 14px;
    }

    .group-search-wrapper .form-control:focus {
        border-color: #25D366;
        box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.25);
        outline: none;
    }

    .group-search-wrapper .btn {
        border-radius: 6px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        border: none;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(37, 211, 102, 0.3);
        white-space: nowrap;
        min-width: 140px;
    }

    .group-search-wrapper .btn:hover {
        background: linear-gradient(135deg, #128C7E 0%, #25D366 100%);
        box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4);
        transform: translateY(-2px);
    }

    .group-search-wrapper .btn:active {
        transform: translateY(0);
    }

    .group-search-wrapper .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    .groups-dropdown {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-height: 400px;
        overflow-y: auto;
        z-index: 9999;
        margin-top: 5px;
        display: none;
    }

    .groups-dropdown::-webkit-scrollbar {
        width: 8px;
    }

    .groups-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .groups-dropdown::-webkit-scrollbar-thumb {
        background: #25D366;
        border-radius: 4px;
    }

    .groups-dropdown::-webkit-scrollbar-thumb:hover {
        background: #128C7E;
    }

    .group-item {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        position: relative;
    }

    .group-item:last-child {
        border-bottom: none;
    }

    .group-item:hover {
        background: linear-gradient(90deg, #f0fff4 0%, #e8f5e9 100%);
        border-left: 4px solid #25D366;
        padding-left: 11px;
    }

    .group-item.selected {
        background: linear-gradient(90deg, #c8e6c9 0%, #a5d6a7 100%);
        border-left: 4px solid #128C7E;
        padding-left: 11px;
    }

    .group-item-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        margin-left: 15px;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
    }

    .group-item-content {
        flex: 1;
        min-width: 0;
    }

    .group-item-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .group-item-id {
        font-size: 12px;
        color: #666;
        font-family: 'Courier New', monospace;
        background: #f5f5f5;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        word-break: break-all;
    }

    .group-item-check {
        margin-right: 10px;
        color: #25D366;
        font-size: 20px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .group-item.selected .group-item-check {
        opacity: 1;
    }

    .groups-empty {
        padding: 30px;
        text-align: center;
        color: #999;
    }

    .groups-empty i {
        font-size: 48px;
        margin-bottom: 10px;
        color: #ddd;
    }

    .group-loading {
        padding: 20px;
        text-align: center;
        color: #25D366;
    }

    .group-loading i {
        font-size: 24px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .group-selected-info {
        margin-top: 15px;
        padding: 15px;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border-radius: 8px;
        border-right: 4px solid #25D366;
        display: none;
    }

    .group-selected-info.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .group-selected-info-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .group-selected-info-header i {
        color: #25D366;
        font-size: 18px;
        margin-left: 8px;
    }

    .group-selected-info-header strong {
        color: #128C7E;
        font-size: 14px;
    }

    .group-selected-name {
        color: #333;
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 5px;
    }

    .group-selected-id {
        color: #666;
        font-size: 12px;
        font-family: 'Courier New', monospace;
        background: white;
        padding: 6px 10px;
        border-radius: 4px;
        display: inline-block;
        word-break: break-all;
    }

    .group-help-text {
        margin-top: 8px;
        font-size: 12px;
        color: #666;
        line-height: 1.5;
    }

    .group-help-text i {
        color: #25D366;
        margin-left: 5px;
    }

    /* Form improvements */
    .form-control {
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #25D366;
        box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.25);
    }

    .control-label {
        color: #333;
        font-weight: 600;
    }

    .control-label.required::after {
        content: " *";
        color: #dc3545;
    }
</style>
<h1 class="text-center mb-30">@ViewBag.Title</h1>
@Html.ValidationSummary(false, "", new { @class = "text-danger" })
@using (Html.BeginForm("Edit", "Users", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    <input name="type" value="@ViewBag.q" hidden />
    @Html.HiddenFor(d => d.Id)
    @Html.HiddenFor(d => d.UserType)
    @* @Html.HiddenFor(d => d.site) *@
    @Html.AntiForgeryToken()
    <div class="row" style="margin:10px;">
        <div class="col-lg-6 mb-10">
            <div class="form-group">
                <label for="NameEn" class="col-sm-5 control-label required">الاسم:</label>
                <div class="col-sm-7">
                    <input asp-for="Name" type="text" required id="Name" class="form-control valid" />
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-10">
            <div class="form-group">
                <label for="NameEn" class="col-sm-5 control-label required">اسم الفرع:</label>
                <div class="col-sm-7">
                    <select asp-for="BranchId" name="BranchId" id="BranchId" class="select2 form-control">
                        @foreach (var branch in branchs)
                        {
                            if (Model.BranchId == branch.Id)
                            {
                                <option selected="selected" value="@branch.Id">@branch.Name - @branch.Address</option>
                            }
                            else
                            {
                                <option value="@branch.Id">@branch.Name - @branch.Address</option>
                            }
                        }
                    </select>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-10">
            <div class="form-group">
                <label for="NameEn" class="col-sm-5 control-label required">الايميل:</label>
                <div class="col-sm-7">
                    <input asp-for="Email" type="email" required id="Email" class="form-control valid" />
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-10">
            <div class="form-group">
                <label for="NameEn" class="col-sm-5 control-label required">رقم الوتساب:</label>
                <div class="col-sm-7">
                    <input asp-for="WhatsappPhone" type="text" required id="Instgram" class="form-control valid" />
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-10">
            <div class="form-group">
                <label for="NameEn" class="col-sm-5 control-label required">رقم الهاتف:</label>
                <div class="col-sm-7">
                    <input asp-for="PhoneNumber" type="text" required id="WhatsApp" class="form-control valid" />
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-10">
            <div class="form-group">
                <label for="NameEn" class="col-sm-5 control-label required">العنوان:</label>
                <div class="col-sm-7">
                    <input asp-for="Address" type="text" required id="WhatsApp" class="form-control valid" />
                </div>
            </div>
        </div>
        @if (ViewBag.q == "a")
        {
           @*  <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="site" class="col-sm-5 control-label required">السيرفر:</label>
                    <div class="col-sm-7">
                        @Html.DropDownListFor(
                                 model => model.site,  // Assuming your model has a 'Site' property
                                 new SelectList(Enum.GetValues(typeof(Site)).Cast<Site>().Select(s => new
                                 {
                                     Value = s,
                                     Text = GetEnumDisplayName(s)
                                 }), "Value", "Text"),
                                 "-- اختر السيرفر --", // Optional default prompt
                                 new { @class = "form-control", id = "site" } // HTML attributes
                                 )
                    </div>
                </div>
            </div> *@
        }
        @if (Model.UserType == PostexS.Models.Enums.UserType.Client)
        {
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="OrdersGeneralNote" class="col-sm-5 control-label required">ملاحظة عامة للطلبات : </label>
                    <div class="col-sm-7">
                        @* @Html.TextArea("OrdersGeneralNote", htmlAttributes: new { @class = "form-control", rows = 7 }) *@
                        @Html.TextAreaFor(model => model.OrdersGeneralNote, new { @class = "form-control", rows = 7 })
                    </div>
                </div>
            </div>
            <div class="col-lg-12 mb-10">
                <hr style="border-top: 2px solid #e0e0e0; margin: 15px 0;">
                <h4 style="text-align: center; color: #555; margin-bottom: 15px;">
                    <i class="fa fa-eye-slash"></i> إعدادات إخفاء بيانات الراسل في البوليصة
                </h4>
            </div>
            <div class="col-lg-4 mb-10">
                <div class="form-group">
                    <label class="col-sm-7 control-label">إخفاء اسم الراسل:</label>
                    <div class="col-sm-5">
                        <div class="button-group">
                            <button type="button" id="hideNameYes" onclick="setHideField('HideSenderName', true)">إخفاء</button>
                            <button type="button" id="hideNameNo" onclick="setHideField('HideSenderName', false)">إظهار</button>
                        </div>
                        <input type="hidden" id="HideSenderName" name="HideSenderName" value="@Model.HideSenderName.ToString().ToLower()" />
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-10">
                <div class="form-group">
                    <label class="col-sm-7 control-label">إخفاء هاتف الراسل:</label>
                    <div class="col-sm-5">
                        <div class="button-group">
                            <button type="button" id="hidePhoneYes" onclick="setHideField('HideSenderPhone', true)">إخفاء</button>
                            <button type="button" id="hidePhoneNo" onclick="setHideField('HideSenderPhone', false)">إظهار</button>
                        </div>
                        <input type="hidden" id="HideSenderPhone" name="HideSenderPhone" value="@Model.HideSenderPhone.ToString().ToLower()" />
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-10">
                <div class="form-group">
                    <label class="col-sm-7 control-label">إخفاء رقم الراسل:</label>
                    <div class="col-sm-5">
                        <div class="button-group">
                            <button type="button" id="hideCodeYes" onclick="setHideField('HideSenderCode', true)">إخفاء</button>
                            <button type="button" id="hideCodeNo" onclick="setHideField('HideSenderCode', false)">إظهار</button>
                        </div>
                        <input type="hidden" id="HideSenderCode" name="HideSenderCode" value="@Model.HideSenderCode.ToString().ToLower()" />
                    </div>
                </div>
            </div>
            <div class="col-lg-12 mb-10">
                <hr style="border-top: 2px solid #e0e0e0; margin: 15px 0;">
            </div>
            <div class="col-lg-12 mb-10">
                <div class="form-group">
                    <label for="WhatsappGroupId" class="col-sm-3 control-label">
                        <i class="fa fa-whatsapp" style="color: #25D366; font-size: 18px;"></i> جروب واتساب :
                    </label>
                    <div class="col-sm-9">
                        <div class="whatsapp-group-container">
                            <input asp-for="WhatsappGroupId" type="text" id="WhatsappGroupId" class="form-control" placeholder="120363XXXXXXXXXX@@g.us" style="display: none;" />
                            
                            <div class="group-search-wrapper">
                                <input type="text" id="groupSearch" class="form-control" placeholder="ابحث عن الجروب أو أدخل Group ID يدوياً..." autocomplete="off" />
                                <button type="button" class="btn" id="btnLoadGroups">
                                    <i class="fa fa-refresh"></i> جلب الجروبات
                                </button>
                            </div>
                            
                            <div id="groupsDropdown" class="groups-dropdown"></div>
                            
                            <div id="selectedGroupInfo" class="group-selected-info">
                                <div class="group-selected-info-header">
                                    <i class="fa fa-check-circle"></i>
                                    <strong>الجروب المختار:</strong>
                                </div>
                                <div class="group-selected-name" id="selectedGroupName"></div>
                                <div class="group-selected-id" id="selectedGroupId"></div>
                            </div>
                            
                            <div class="group-help-text">
                                <i class="fa fa-info-circle"></i>
                                اضغط "جلب الجروبات" لعرض جميع الجروبات المتاحة، أو أدخل Group ID يدوياً (يجب أن ينتهي بـ @@g.us)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        @if (Model.UserType == PostexS.Models.Enums.UserType.Driver)
        {
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">تكلفة التوصيل :</label>
                    <div class="col-sm-7">
                        <input asp-for="DeliveryCost" type="number" min="0" id="DeliveryCost" class="form-control valid" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="Tracking" class="col-sm-5 control-label required">تتبع المندوب :</label>
                    <div class="col-sm-7">
                        <div class="button-group">
                            <button type="button" id="yesButton" onclick="selectYes()">نعم</button>
                            <button type="button" id="noButton" onclick="selectNo()">لا</button>
                        </div>
                        <input type="hidden" id="Tracking" name="Tracking" value="@Model.Tracking.ToString().ToLower()" />
                    </div>
                </div>
            </div>
            <hr>
            <div class="col-lg-12"></div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">وجة صورة البطاقة:</label>
                    <div class="col-sm-7">
                        <input name="IdentityFrontPhoto" type="file" id="IdentityFrontPhoto" class="form-control valid" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">وجة صورة البطاقة:</label>
                    <div class="col-sm-7">
                        <img src="/Images/Users/@Model.IdentityFrontPhoto" style="width:10rem" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">ضهر صورة البطاقة:</label>
                    <div class="col-sm-7">
                        <input name="IdentityBackPhoto" type="file" id="IdentityBackPhoto" class="form-control valid" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">ضهر  صورة البطاقة:</label>
                    <div class="col-sm-7">
                        <img src="/Images/Users/@Model.IdentityBackPhoto" style="width:10rem" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">   رخصة القيادة:</label>
                    <div class="col-sm-7">
                        <input name="RidingLecencePhoto" type="file" id="RidingLecencePhoto" class="form-control valid" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required"> رخصة القيادة:</label>
                    <div class="col-sm-7">
                        <img src="/Images/Users/@Model.RidingLecencePhoto" style="width:10rem" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">   رخصة المركبة :</label>
                    <div class="col-sm-7">
                        <input name="ViecleLecencePhoto" type="file" id="ViecleLecencePhoto" class="form-control valid" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required"> رخصة المركبة:</label>
                    <div class="col-sm-7">
                        <img src="/Images/Users/@Model.ViecleLecencePhoto" style="width:10rem" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">   فيش جنائي :</label>
                    <div class="col-sm-7">
                        <input name="FishPhotoPhoto" type="file" id="FishPhotoPhoto" class="form-control valid" />
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-10">
                <div class="form-group">
                    <label for="NameEn" class="col-sm-5 control-label required">  فيش جنائي:</label>
                    <div class="col-sm-7">
                        <img src="/Images/Users/@Model.FishPhotoPhoto" style="width:10rem" />
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="row" style="margin:10px;">
        <div class="col-lg-6 mb-10">
            <div class="form-group">
                <label for="NameEn" class="col-sm-5 control-label required"></label>
                <div class="col-sm-7">
                    <button style="text-align:center !important" type="submit" class="btn btn-success">تعديل</button>
                </div>
            </div>
        </div>
    </div>
}

@functions {
    public string GetEnumDisplayName(Enum value)
    {
        var field = value.GetType().GetField(value.ToString());
        var attribute = field.GetCustomAttributes(typeof(DisplayAttribute), false).FirstOrDefault() as DisplayAttribute;
        return attribute != null ? attribute.Name : value.ToString();
    }
}
<!-- Modal for Invite Link -->
<div class="modal fade" id="inviteLinkModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title"><i class="fa fa-link"></i> جلب معرف الجروب من لينك الدعوة</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>لينك دعوة الجروب:</label>
                    <input type="text" id="inviteLinkInput" class="form-control" placeholder="https://chat.whatsapp.com/ABC123..." />
                    <small class="text-muted">الصق لينك الدعوة هنا (مثال: https://chat.whatsapp.com/J00XcsDj99ABU9ioGWAN4N)</small>
                </div>
                <div id="inviteLinkResult" class="alert" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">إلغاء</button>
                <button type="button" id="btnGetGroupId" class="btn btn-primary">
                    <i class="fa fa-search"></i> جلب معرف الجروب
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function selectYes() {
            document.getElementById('Tracking').value = 'true';
            document.getElementById('yesButton').classList.add('active');
            document.getElementById('noButton').classList.remove('active');
        }

        function selectNo() {
            document.getElementById('Tracking').value = 'false';
            document.getElementById('noButton').classList.add('active');
            document.getElementById('yesButton').classList.remove('active');
        }

        // إعدادات إخفاء بيانات الراسل
        function setHideField(fieldId, value) {
            document.getElementById(fieldId).value = value.toString();
            var yesBtn, noBtn;
            if (fieldId === 'HideSenderName') { yesBtn = 'hideNameYes'; noBtn = 'hideNameNo'; }
            else if (fieldId === 'HideSenderPhone') { yesBtn = 'hidePhoneYes'; noBtn = 'hidePhoneNo'; }
            else if (fieldId === 'HideSenderCode') { yesBtn = 'hideCodeYes'; noBtn = 'hideCodeNo'; }
            if (value) {
                document.getElementById(yesBtn).classList.add('active');
                document.getElementById(noBtn).classList.remove('active');
            } else {
                document.getElementById(noBtn).classList.add('active');
                document.getElementById(yesBtn).classList.remove('active');
            }
        }

        function initHideFields() {
            var fields = ['HideSenderName', 'HideSenderPhone', 'HideSenderCode'];
            fields.forEach(function(fieldId) {
                var el = document.getElementById(fieldId);
                if (el) {
                    setHideField(fieldId, el.value === 'true');
                }
            });
        }

        // Set initial state based on Tracking value
        document.addEventListener('DOMContentLoaded', function () {
            var trackingValue = document.getElementById('Tracking');
            if (trackingValue) {
                if (trackingValue.value === 'true') {
                    selectYes();
                } else {
                    selectNo();
                }
            }
            initHideFields();
        });

        var allGroups = [];
        var selectedGroupId = '@Model.WhatsappGroupId';

        // Load Groups
        $('#btnLoadGroups').click(function () {
            var btn = $(this);
            var originalHtml = btn.html();
            btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> جاري الجلب...');

            // Show loading in dropdown
            $('#groupsDropdown').html('<div class="group-loading"><i class="fa fa-spinner fa-spin"></i><br>جاري جلب الجروبات...</div>').show();

            // WhatsApp Bot Cloud API doesn't need phone number - gets all groups
            $.post('@Url.Action("GetGroupsForPhone", "Users")', {}, function (response) {
                if (response.success && response.groups && response.groups.length > 0) {
                    allGroups = response.groups;
                    renderGroupsDropdown(allGroups);
                    $('#groupsDropdown').show();
                    
                    // Show success message
                    if (response.message) {
                        showNotification('success', response.message);
                    }
                } else {
                    $('#groupsDropdown').html('<div class="groups-empty"><i class="fa fa-inbox"></i><br>' + (response.message || 'لم يتم العثور على جروبات') + '</div>').show();
                    showNotification('warning', response.message || 'لم يتم العثور على جروبات');
                }
                btn.prop('disabled', false).html(originalHtml);
            }).fail(function () {
                $('#groupsDropdown').html('<div class="groups-empty"><i class="fa fa-exclamation-triangle"></i><br>حدث خطأ أثناء جلب الجروبات</div>').show();
                showNotification('error', 'حدث خطأ أثناء جلب الجروبات');
                btn.prop('disabled', false).html(originalHtml);
            });
        });

        // Search in groups
        $('#groupSearch').on('input', function () {
            var searchTerm = $(this).val().toLowerCase().trim();
            
            // If user enters a group ID directly
            if (searchTerm.includes('@@g.us') || searchTerm.match(/^\d+.*@@g\.us$/)) {
                $('#WhatsappGroupId').val(searchTerm);
                $('#groupsDropdown').hide();
                selectedGroupId = searchTerm;
                // Show selected info
                $('#selectedGroupName').text('Group ID يدوياً');
                $('#selectedGroupId').text(searchTerm);
                $('#selectedGroupInfo').addClass('show');
                return;
            }

            if (allGroups.length === 0) {
                $('#groupsDropdown').hide();
                return;
            }

            // Filter groups by name or ID
            var filteredGroups = allGroups.filter(function (group) {
                var nameMatch = group.name && group.name.toLowerCase().includes(searchTerm);
                var idMatch = group.id && group.id.toLowerCase().includes(searchTerm);
                return nameMatch || idMatch;
            });

            if (filteredGroups.length > 0) {
                renderGroupsDropdown(filteredGroups);
                $('#groupsDropdown').show();
            } else if (searchTerm.length > 0) {
                $('#groupsDropdown').html('<div class="groups-empty"><i class="fa fa-search"></i><br>لا توجد نتائج للبحث</div>').show();
            } else {
                $('#groupsDropdown').hide();
            }
        });

        // Show dropdown when search input is focused and has groups
        $('#groupSearch').on('focus', function () {
            if (allGroups.length > 0 && $(this).val().trim() === '') {
                renderGroupsDropdown(allGroups);
                $('#groupsDropdown').show();
            }
        });

        // Render groups dropdown
        function renderGroupsDropdown(groups) {
            var dropdown = $('#groupsDropdown');
            dropdown.empty();

            if (groups.length === 0) {
                dropdown.html('<div class="groups-empty"><i class="fa fa-inbox"></i><br>لا توجد جروبات</div>');
                return;
            }

            groups.forEach(function (group) {
                var isSelected = selectedGroupId === group.id;
                var groupName = group.name || 'بدون اسم';
                var groupInitial = groupName.charAt(0).toUpperCase();
                
                var item = $('<div class="group-item' + (isSelected ? ' selected' : '') + '" data-group-id="' + group.id + '" data-group-name="' + groupName + '">' +
                    '<div class="group-item-icon">' + groupInitial + '</div>' +
                    '<div class="group-item-content">' +
                    '<div class="group-item-name">' + escapeHtml(groupName) + '</div>' +
                    '<div class="group-item-id">' + escapeHtml(group.id) + '</div>' +
                    '</div>' +
                    '<div class="group-item-check"><i class="fa fa-check-circle"></i></div>' +
                    '</div>');
                
                item.click(function (e) {
                    e.preventDefault();
                    var groupId = $(this).data('group-id');
                    var groupName = $(this).data('group-name');
                    
                    // Remove previous selection
                    $('.group-item').removeClass('selected');
                    // Add selection to clicked item
                    $(this).addClass('selected');
                    
                    $('#WhatsappGroupId').val(groupId);
                    $('#groupSearch').val(groupName);
                    $('#groupsDropdown').slideUp(200);
                    selectedGroupId = groupId;
                    
                    // Show selected group info with animation
                    $('#selectedGroupName').text(groupName);
                    $('#selectedGroupId').text(groupId);
                    $('#selectedGroupInfo').addClass('show');
                    
                    // Show success notification
                    showNotification('success', 'تم اختيار الجروب: ' + groupName);
                });
                
                dropdown.append(item);
            });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Show notification
        function showNotification(type, message) {
            var alertClass = type === 'success' ? 'alert-success' : 
                           type === 'warning' ? 'alert-warning' : 
                           'alert-danger';
            var icon = type === 'success' ? 'fa-check-circle' : 
                      type === 'warning' ? 'fa-exclamation-triangle' : 
                      'fa-times-circle';
            
            var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade in" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">' +
                '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                '<i class="fa ' + icon + '"></i> ' + escapeHtml(message) +
                '</div>');
            
            $('body').append(notification);
            
            setTimeout(function() {
                notification.fadeOut(function() {
                    $(this).remove();
                });
            }, 3000);
        }

        // Hide dropdown when clicking outside
        $(document).click(function (e) {
            if (!$(e.target).closest('#groupSearch, #groupsDropdown, #btnLoadGroups').length) {
                $('#groupsDropdown').hide();
            }
        });

        // Initialize with existing value
        if (selectedGroupId && selectedGroupId.trim() !== '' && selectedGroupId !== 'null' && selectedGroupId !== 'undefined') {
            $('#groupSearch').val(selectedGroupId);
            $('#selectedGroupName').text('Group ID: ' + selectedGroupId);
            $('#selectedGroupId').text(selectedGroupId);
            $('#selectedGroupInfo').addClass('show');
        }
    </script>
}
